name: PR Branch Deletion

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  delete-branch:
    runs-on: ubuntu-latest
    # Only run if merged AND the branch is NOT app-stg or api-stg
    if: |
      github.event.pull_request.merged == true && 
      github.event.pull_request.head.ref != 'app-stg' && 
      github.event.pull_request.head.ref != 'api-stg' &&
      github.event.pull_request.head.ref != 'main' &&
      github.event.pull_request.head.ref != 'master'

    steps:
      - name: Log Workflow Context
        uses: actions/github-script@v7
        with:
          script: |
            console.log('üîç Workflow Context Information:');
            console.log(`Repository: ${context.repo.owner}/${context.repo.repo}`);
            console.log(`PR Number: #${context.payload.pull_request.number}`);
            console.log(`PR Title: "${context.payload.pull_request.title}"`);
            console.log(`Branch to delete: ${context.payload.pull_request.head.ref}`);
            console.log(`Base branch: ${context.payload.pull_request.base.ref}`);
            console.log(`PR Author: ${context.payload.pull_request.user.login}`);
            console.log(`Merged by: ${context.payload.pull_request.merged_by?.login || 'Unknown'}`);
            console.log(`Merged at: ${context.payload.pull_request.merged_at}`);

      - name: Delete branch
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            
            try {
              console.log('üóëÔ∏è Starting branch deletion process...');
              console.log(`Target branch: ${branchName}`);
              
              // Check if branch exists before deletion
              console.log('Verifying branch exists...');
              try {
                await github.rest.git.getRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${branchName}`
                });
                console.log('‚úÖ Branch exists and is ready for deletion');
              } catch (error) {
                if (error.status === 404) {
                  console.log('‚ÑπÔ∏è Branch already deleted or does not exist');
                  return;
                }
                throw error;
              }
              
              // Perform the deletion
              console.log(`üîÑ Attempting to delete branch: ${branchName}`);
              const response = await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`
              });
              
              console.log(`‚úÖ Branch '${branchName}' successfully deleted`);
              console.log(`Response status: ${response.status}`);
              
              // Add a comment to the PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `üóëÔ∏è Branch \`${branchName}\` has been automatically deleted after merge.`
              });
              
              console.log('‚úÖ Added cleanup notification comment to PR');
              
            } catch (error) {
              console.error('‚ùå Error during branch deletion:');
              console.error(`Error message: ${error.message}`);
              console.error(`Error status: ${error.status || 'Unknown'}`);
              console.error(`Error response: ${JSON.stringify(error.response?.data || {}, null, 2)}`);
              
              // Don't fail the workflow for deletion errors
              console.log('‚ö†Ô∏è Continuing workflow despite deletion error...');
            }

      - name: Workflow Summary
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const branchName = context.payload.pull_request.head.ref;
            console.log('üìã Workflow Summary:');
            console.log(`Branch processed: ${branchName}`);
            console.log(`Job status: ${job.status || 'completed'}`);
            console.log(`Timestamp: ${new Date().toISOString()}`);
            console.log('‚úÖ PR Branch Deletion workflow completed');